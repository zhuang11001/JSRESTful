<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=9" />
    <title>接口测试</title>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
</head>
<style>
    .nav{
        margin-top: 50px;
    }
    .nav a{
        color: #000000;
    }
    .affix .nav>li>a{
        padding: 5px 15px;
        font-size: 14px;
    }
    .roll{
        height:500px;overflow-y:auto;
    }
    .top{
        margin: 20px 0;
    }
</style>
<body>
<div class="container">
    <div class="col-md-9">
        <div class="top">
            <h2>接口测试demo 版本1.1.37.1 </h2>
            <span class="label label-success" style="display: none;padding: 10px">设备已插入</span>
            <span class="label label-danger" style="display: none;padding: 10px">设备已拔出</span>

        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="GetUserListData-pos">
                <h4>1、获取证书列表接口</h4>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="GetUserList()">获取证书列表接口</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="GetUserListTxt" cols="150" rows="5" disabled></textarea>
                </div>
                <div class="form-group">
                    <h5>唯一标识：</h5>
                    <input value="" type="text" class="form-control" id="GetUserListData" disabled>
                </div>

            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="CertLogin-pos">
                <h4>2、证书口令验证接口</h4>
                <div class="form-group">
                    <label for="containerId" class="control-label">唯一标识:</label>
                    <input type="text" class="form-control" id="containerId">
                </div>
                <div class="form-group">
                    <label for="password" class="control-label">证书口令:</label>
                    <input type="text" class="form-control" id="password">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="CertLogin()">证书口令验证接口</button>
                    <p class="text-danger" id="danger">请勿连续输入错误口令</p>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="CertLoginTxt" cols="150" rows="5" disabled></textarea>
                </div>

            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="GetCertBase64String-pos">
                <h4>3、获取数字证书接口</h4>
                <div class="form-group">
                    <label for="certType" class="control-label">1(签名证书)，2(加密证书):</label>
                    <input type="text" class="form-control" id="certType">
                </div>
                <div class="form-group">
                    <label for="containerId3" class="control-label">唯一标识:</label>
                    <input type="text" class="form-control" id="containerId3">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="GetCertBase64String()">获取数字证书接口</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="GetCertBase64StringTxt" cols="150" rows="5" disabled></textarea>
                </div>
                <div class="form-group">
                    <h5>证书base64编码：</h5>
                    <input type="text" class="form-control" id="GetCertBase64StringData" disabled>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="GetCertInfo-pos">
                <h4>4、获取证书信息接口</h4>
                <div class="form-group">
                    <label for="certBase64" class="control-label">证书base64编码:</label>
                    <input type="text" class="form-control" id="certBase64">
                </div>
                <div class="form-group">
                    <label for="type" class="control-label">信息标识，例如传2可获取证书序列号:</label>
                    <input type="text" class="form-control" id="type">
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="GetCertInfo()">获取证书信息接口</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="GetCertInfoTxt" cols="150" rows="5" disabled></textarea>
                </div>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="KeyGetKeySn-pos">
                <h4>5、获取证书用户标识接口</h4>
                <div class="form-group">
                    <label for="SncontainerId" class="control-label">唯一标识:</label>
                    <input type="text" class="form-control" id="SncontainerId">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="KeyGetKeySn()">获取证书用户标识接口</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="KeyGetKeySnTxt" cols="150" rows="5" disabled></textarea>
                </div>

            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="KeyEncryptData-pos">
                <h4>6、非对称加密接口</h4>
                <div class="form-group">
                    <label for="rsKey" class="control-label">待加密明文:</label>
                    <input type="text" class="form-control" id="rsKey">
                </div>
                <div class="form-group">
                    <label for="certBase64" class="control-label">证书base64编码:</label>
                    <input type="text" class="form-control" id="KeycertBase64">
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="KeyEncryptData()">非对称加密</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="KeyEncryptDataTxt" cols="150" rows="5" disabled></textarea>
                </div>
                <div class="form-group">
                    <h5>密文：</h5>
                    <input value="" type="text" class="form-control" id="KeyEncryptDataData" disabled>
                </div>

            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-body" id="KeyDecryptData-pos">
                <h4>7、非对称解密接口</h4>
                <div class="form-group">
                    <label for="containerId6" class="control-label">唯一标识:</label>
                    <input type="text" class="form-control" id="containerId6">
                </div>
                <div class="form-group">
                    <label for="encRsKey" class="control-label">待解密的密文:</label>
                    <input type="text" class="form-control" id="encRsKey">
                </div>

                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="KeyDecryptData()">非对称解密</button>
                </div>
                <div class="form-group">
                    <textarea class="form-control" id="KeyDecryptDataTxt" cols="150" rows="5" disabled></textarea>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3" id="nav-right">
        <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix">
            <ul class="nav bs-docs-sidenav">
                <li class="">
                    <a href="#GetUserListData-pos">1、获取证书列表接口</a>
                </li>
                <li class="">
                    <a href="#CertLogin-pos">2、证书口令验证接口</a>
                </li>
                <li class="">
                    <a href="#GetCertBase64String-pos">3、获取数字证书接口</a>
                </li>
                <li class="">
                    <a href="#GetCertInfo-pos">4、获取证书信息接口</a>
                </li>

                <li class="">
                    <a href="#KeyGetKeySn-pos">5、获取证书用户标识接口</a>
                </li>
                <li class="">
                    <a href="#KeyEncryptData-pos">6、非对称加密接口</a>
                </li>
                <li class="">
                    <a href="#KeyDecryptData-pos">7、非对称解密接口</a>
                </li>
                <li class="">
                    <a class="back-to-top" href="#top">
                        返回顶部
                    </a>
                </li>
            </ul>
        </nav>
    </div>
</div>
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="exampleModalLabel">证书口令验证:</h4>
            </div>
            <div class="modal-body">
                <form>
                    <div class="form-group">
                        <label for="model-containerId" class="control-label">唯一标识:</label>
                        <input type="text" class="form-control" id="model-containerId">
                    </div>
                    <div class="form-group">
                        <label for="model-password" class="control-label">口令:</label>
                        <input type="text" class="form-control" id="model-password">
                        <p class="text-danger" id="model-danger">请勿连续输入错误口令</p>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" onclick="getContainerId()">获取唯一标识</button>
                <button type="button" class="btn btn-primary" onclick="ModelLogin()">验证口令</button>
            </div>
        </div>
    </div>
</div>
<div style="margin-bottom: 150px;"></div>
</body>
<script src="./js/jquery.min.js" type="text/javascript"></script>
<script src="./js/html5shiv.js" type="text/javascript"></script>
<script src="./js/respond.js" type="text/javascript"></script>
<script src="./js/bootstrap.min.js" type="text/javascript"></script>
<script src="./js/JSRESTful.js" type="text/javascript"></script>
<script type="text/javascript">
    /**插入状态 0：无设备插入 1:允许请求 2:插入设备大于1*/
    var RS_state = 0;
    if (document.all && document.querySelector && !document.addEventListener) {
        $("#nav-right").attr("style","display:none");
    }
    jQuery.support.cors=true;
    if(!window.console){
        window.console = {};
        window.console.log = function(){};
    }
    $(function(){
        ajaxBuffer();
        var url = window.location.toString();
        var id = url.split("#")[1];
        if(id){
            var t = $("#"+id).offset().top;
            $(window).scrollTop(t);
        }
        if($(window).height()<700){
            $(".nav").addClass("roll");
        }
    });
    //轮询，查询插拔状态
    function ajaxBuffer(){
        buffer(function(res){
            if(res.length==1){
                $(".label-success").show();
                $(".label-danger").hide();
                RS_state = 1;
            }else if(res.length>1){
                $(".label-success").hide();
                $(".label-danger").show();
                $(".label-danger").text("插入的设备数大于1");
                RS_state = 2;
            }else{
                $(".label-success").hide();
                $(".label-danger").show();
                $(".label-danger").text("无设备插入中");
                RS_state = 0;
            }
        });
    }
    setInterval("ajaxBuffer()",5000);

    function getBuffer(){
        ajaxBuffer();
        if(RS_state==0){
            alert("无设备插入,无法发起请求");
            return false;
        }else if(RS_state==2){
            alert("插入的设备数大于1,无法发起请求");
            return false;
        }
    }
    //获取证书列表接口
    function GetUserList(){
        document.getElementById("GetUserListTxt").value = "加载中...";
        getBuffer();
        var res =RS_GetUserList();
        setTimeout(function(){
            if(res.code){
                if(res.msg=="UDevice open failed!"){
                    document.getElementById("GetUserListTxt").value = "福建ca请使用IE浏览器";
                }else{
                    var msg= '{\n    "code":"'+res.code+'",\n    "data":{\n        "userlist":"'+res.data.userlist+'"\n    },\n    "msg":'+res.msg+'"\n}';
                    console.log(res);
                    var i = res.data.userlist.indexOf("||");
                    var j = res.data.userlist.slice(i+2);
                    document.getElementById("GetUserListTxt").value = msg;
                    document.getElementById("GetUserListData").value = j;
                    document.getElementById("containerId3").value = j;
                    document.getElementById("containerId").value = j;
                    document.getElementById("model-containerId").value = j;
                    document.getElementById("containerId6").value = j;
                    document.getElementById("SncontainerId").value = j;
                }

            }else{
                document.getElementById("GetUserListTxt").value = "获取证书列表失败";
            }
        }, 500);
    }
    //
    //证书口令验证接口
    function CertLogin(){
        var containerId=$("#containerId").val();
        var password=$("#password").val();
        document.getElementById("CertLoginTxt").value = "加载中...";
        getBuffer();
        var res = RS_CertLogin(containerId, password);
        setTimeout(function(){
            if(res.code){
                var msg=JSON.stringify(res,null,3);
                document.getElementById("CertLoginTxt").value = msg;
                var num = RS_GetPinRetryCount(containerId);
                if(num.code=="0000"){
                    document.getElementById("danger").innerHTML = "口令尝试剩余次数："+num.data.retryCount;
                }else{
                    document.getElementById("danger").innerHTML = "请勿连续输入错误口令";
                }

            }else{
                document.getElementById("CertLoginTxt").value = "验证口令失败";
                var num = RS_GetPinRetryCount(containerId);
                if(num.code=="0000"){
                    document.getElementById("danger").innerHTML = "口令尝试剩余次数："+num.data.retryCount;
                }else{
                    document.getElementById("danger").innerHTML = "请勿连续输入错误口令";
                }
            }

        }, 500);
    }
    //获取数字证书接口
    function GetCertBase64String(){
        document.getElementById("GetCertBase64StringTxt").value = "加载中...";
        var certType=$("#certType").val();
        var containerId=$("#containerId3").val();
        getBuffer();
        var res = RS_GetCertBase64String(certType, containerId);
        setTimeout(function(){
            if(res.code){
                var msg = JSON.stringify(res,null,3);
                document.getElementById("GetCertBase64StringTxt").value = msg;
                document.getElementById("GetCertBase64StringData").value = res.data.certBase64;
                document.getElementById("certBase64").value = res.data.certBase64;
                document.getElementById("KeycertBase64").value = res.data.certBase64;
            }else{
                document.getElementById("GetCertBase64StringTxt").value = "获取数字证书失败";
            }
        }, 500);
    }
    //获取证书信息接口
    function GetCertInfo(){
        document.getElementById("GetCertInfoTxt").value = "加载中...";
        var certBase64=$("#certBase64").val();
        var type=$("#type").val();
        var res=RS_GetCertInfo(certBase64, type);
        setTimeout(function(){
            if(res.code){
                var msg= '{\n    "code":"'+res.code+'",\n    "data":{\n        "info":"'+res.data.info+'"\n    },\n    "msg":"'+res.msg+'"\n}';
                document.getElementById("GetCertInfoTxt").value = msg;
            }else{
                document.getElementById("GetCertInfoTxt").value = "获取证书信息失败";
            }
        }, 500);
    }

    //获取证书用户标识接口
    function KeyGetKeySn(){
        document.getElementById("KeyGetKeySnTxt").value = "加载中...";
        var containerId=$("#SncontainerId").val();
        getBuffer();
        var res=RS_KeyGetKeySn(containerId);
        setTimeout(function(){
            if(res.code){
                var msg=JSON.stringify(res,null,3);
                document.getElementById("KeyGetKeySnTxt").value = msg;
            }else{
                document.getElementById("KeyGetKeySnTxt").value = "获取证书用户标识失败";
            }
        }, 500);
    }

    //非对称加密接口
    function KeyEncryptData(){
        document.getElementById("KeyEncryptDataTxt").value = "加载中...";
        var rsKey=$("#rsKey").val();
        var certBase64=$("#KeycertBase64").val();
        getBuffer();
        var res=RS_KeyEncryptData(rsKey, certBase64);
        setTimeout(function(){
            if(res.code){
                var msg=JSON.stringify(res,null,3);
                document.getElementById("KeyEncryptDataTxt").value = msg;
                document.getElementById("KeyEncryptDataData").value = res.data.encRsKey;
                document.getElementById("encRsKey").value = res.data.encRsKey;
            }else{
                document.getElementById("KeyEncryptDataTxt").value = "非对称加密失败";
            }
        }, 500);
    }
    //非对称解密接口
    function KeyDecryptData(){
        document.getElementById("KeyDecryptDataTxt").value = "加载中...";
        getBuffer();
        $('#loginModal').modal();
    }
    function keyDecrypt(){
        var encRsKey=$("#encRsKey").val();
        var containerId=$("#containerId6").val();
        var res=RS_KeyDecryptData(encRsKey, containerId);
        setTimeout(function(){
          if(res.code){
                var msg= '{\n    "code":"'+res.code+'",\n    "data":{\n        "rsKey":"'+res.data.rsKey+'"\n    },\n    "msg":"'+res.msg+'"\n}';
                document.getElementById("KeyDecryptDataTxt").value = msg;
            }else{
                document.getElementById("KeyDecryptDataTxt").value = "非对称解密失败";
            }
        }, 500);
    }

    function ModelLogin(){
        var containerId=$("#model-containerId").val();
        var password=$("#model-password").val();
        if(!containerId){
            alert("请先获取证书列表");
        }else if(!password){
            alert("请输入口令");
        }else{
            var res = RS_CertLogin(containerId,password);
            setTimeout(function(){
                if(res.code=="0000"){
                    alert("口令验证成功");
                    var num = RS_GetPinRetryCount(containerId);
                    if(num.code=="0000"){
                        document.getElementById("model-danger").innerHTML = "口令尝试剩余次数："+num.data.retryCount;
                    }else{
                        document.getElementById("model-danger").innerHTML = "请勿连续输入错误口令";
                    }
                    keyDecrypt();
                }else{
                    alert("口令验证失败");
                }

            }, 500);
            $('#loginModal').modal('toggle');
        }
    }
    function getContainerId(){
        $('#loginModal').modal('toggle');
        $("html,body").animate({scrollTop:$("#GetUserListData-pos").offset().top},1000);
    }
</script>
</html>
